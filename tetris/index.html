<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard ê´€ë¦¬ì (ì¶”ê°€/ì‚­ì œ)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,"Pretendard","Malgun Gothic",sans-serif;margin:0;background:#0f1320;color:#eaeaf0}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    h2{margin:0 0 12px}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1}
    input,button{padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#eaeaf0}
    button{cursor:pointer;background:#273150;font-weight:700}
    button:hover{filter:brightness(1.06)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .danger{background:rgba(184,59,59,.18);border-color:rgba(184,59,59,.55)}
    .ok{background:rgba(47,125,78,.18);border-color:rgba(47,125,78,.55)}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);white-space:pre-wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:rgba(234,234,240,.75)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left}
    th{font-size:12px;color:rgba(234,234,240,.7)}
    .right{text-align:right}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){ .split{grid-template-columns:1fr 1fr;} }
    .label{font-size:12px;color:rgba(234,234,240,.7);margin:8px 0 6px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>ğŸ Leaderboard ê´€ë¦¬ì (ë¹„ë²ˆ + ì¶”ê°€/ì‚­ì œ)</h2>

  <div class="split">

    <!-- ì¢Œ: ê´€ë¦¬ì ë¹„ë²ˆ + ì‚­ì œ RPC -->
    <div class="card">
      <div class="mono">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(ì‚­ì œìš© RPC):</div>
      <div class="row" style="margin-top:8px">
        <input id="pw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
        <button id="loadBtn" type="button">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div id="msg" class="msg" style="display:none;"></div>
      <div class="mono" style="margin-top:8px">
        ì‚­ì œëŠ” RPC(admin_delete_leaderboard)ë¡œ ì²˜ë¦¬ë¨.
      </div>
    </div>

    <!-- ìš°: ì¶”ê°€ í¼ (INSERT) -->
    <div class="card">
      <div class="mono">ë­í‚¹ ì¶”ê°€(INSERT):</div>

      <div class="label">ì´ë¦„</div>
      <input id="name" placeholder="ì´ë¦„" />

      <div class="row">
        <div>
          <div class="label">ì ìˆ˜</div>
          <input id="score" type="number" placeholder="ì ìˆ˜" />
        </div>
        <div>
          <div class="label">ìµœëŒ€ ì½¤ë³´</div>
          <input id="max_combo" type="number" placeholder="ìµœëŒ€ì½¤ë³´" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="addBtn" class="ok" type="button">ì¶”ê°€</button>
        <button id="resetBtn" type="button">ì´ˆê¸°í™”</button>
      </div>

      <div class="mono" style="margin-top:8px">
        âš ï¸ ì¶”ê°€ê°€ ì•ˆ ë˜ë©´ Supabase Policiesì—ì„œ INSERT(anon) í—ˆìš© í•„ìš”.
      </div>
    </div>

  </div>

  <div style="height:12px"></div>

  <div class="card">
    <div class="row">
      <input id="search" placeholder="ì´ë¦„ ê²€ìƒ‰" />
      <button id="refreshBtn" type="button">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì´ë¦„</th>
          <th class="right">ì ìˆ˜</th>
          <th class="right">ìµœëŒ€ì½¤ë³´</th>
          <th>ì‹œê°„</th>
          <th class="right">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="mono">ë¶ˆëŸ¬ì˜¤ê¸° ì „â€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://oykepnxnbyltcvcqnfbe.supabase.co",
    "sb_publishable_85W1hHMVmhILGBbrX-l4wg_qmLCn987"
  );

  const msg = document.getElementById("msg");
  const tbody = document.getElementById("tbody");
  const pwEl = document.getElementById("pw");
  const searchEl = document.getElementById("search");

  const nameEl = document.getElementById("name");
  const scoreEl = document.getElementById("score");
  const maxComboEl = document.getElementById("max_combo");

  let rows = [];

  function show(text){
    msg.style.display = text ? "block" : "none";
    msg.textContent = text || "";
  }

  function fmt(iso){
    try{ return new Date(iso).toLocaleString(); }catch{ return iso; }
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function render(){
    const q = searchEl.value.trim().toLowerCase();
    const filtered = q ? rows.filter(r => (r.name||"").toLowerCase().includes(q)) : rows;

    if(!filtered.length){
      tbody.innerHTML = `<tr><td colspan="6" class="mono">ë°ì´í„° ì—†ìŒ</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td>
          <div>${escapeHtml(r.name ?? "")}</div>
          <div class="mono">${escapeHtml(String(r.id ?? ""))}</div>
        </td>
        <td class="right">${escapeHtml(String(r.score ?? ""))}</td>
        <td class="right">${escapeHtml(String(r.max_combo ?? ""))}</td>
        <td class="mono">${escapeHtml(fmt(r.created_at))}</td>
        <td class="right">
          <button class="danger" data-id="${escapeHtml(String(r.id))}">ì‚­ì œ</button>
        </td>
      </tr>
    `).join("");

    tbody.querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        await del(id);
      });
    });
  }

  async function load(){
    show("");
    tbody.innerHTML = `<tr><td colspan="6" class="mono">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>`;

    const { data, error } = await supabase
      .from("leaderboard")
      .select("id, created_at, name, score, max_combo")
      .order("score", { ascending: false })
      .order("max_combo", { ascending: false })
      .order("created_at", { ascending: true })
      .limit(500);

    if(error){
      rows = [];
      show("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message);
      tbody.innerHTML = `<tr><td colspan="6" class="mono">ì‹¤íŒ¨</td></tr>`;
      return;
    }

    rows = data || [];
    render();
  }

  async function addRow(){
    show("");

    const name = (nameEl.value || "").trim();
    const score = Number(scoreEl.value);
    const max_combo = Number(maxComboEl.value);

    if(!name){ alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜!"); return; }
    if(!Number.isFinite(score)){ alert("ì ìˆ˜(ìˆ«ì)ë¥¼ ì…ë ¥í•´ì¤˜!"); return; }
    if(!Number.isFinite(max_combo)){ alert("ìµœëŒ€ì½¤ë³´(ìˆ«ì)ë¥¼ ì…ë ¥í•´ì¤˜!"); return; }

    // âœ… INSERTëŠ” ì •ì±…(public insert leaderboard)ì´ í—ˆìš©í•´ì•¼ í•¨
    const { error } = await supabase
      .from("leaderboard")
      .insert([{ name, score, max_combo }]);

    if(error){
      show("ì¶”ê°€ ì‹¤íŒ¨: " + error.message + "\n\n(Policiesì—ì„œ INSERT/anon í—ˆìš© í™•ì¸)");
      return;
    }

    show("ì¶”ê°€ ì™„ë£Œ!");
    nameEl.value = "";
    scoreEl.value = "";
    maxComboEl.value = "";
    await load();
  }

  async function del(id){
    const password = pwEl.value;
    if(!password){ alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì¤˜!"); return; }
    if(!confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”?\n\nid: ${id}`)) return;

    const { data, error } = await supabase.rpc("admin_delete_leaderboard", {
      p_password: password,
      p_id: String(id),
    });

    if(error){ show("ì‚­ì œ ì‹¤íŒ¨: " + error.message); return; }
    if(!data?.ok){ show("ì‚­ì œ ì‹¤íŒ¨: " + (data?.error || "UNKNOWN")); return; }

    show(`ì‚­ì œ ì™„ë£Œ! (deleted=${data.deleted})`);
    rows = rows.filter(r => String(r.id) !== String(id));
    render();
  }

  document.getElementById("loadBtn").addEventListener("click", load);
  document.getElementById("refreshBtn").addEventListener("click", load);
  document.getElementById("addBtn").addEventListener("click", addRow);
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    nameEl.value=""; scoreEl.value=""; maxComboEl.value="";
  });
  searchEl.addEventListener("input", render);
</script>
</body>
</html>
