<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Leaderboard Admin</title>
  <style>
    :root{
      --bg:#121621; --glass: rgba(255,255,255,.06); --ink: rgba(0,0,0,.35);
      --btn:#273150; --btnBorder: rgba(255,255,255,.15);
      --hud:#eaeaf0; --accent:#ffd974; --danger:#5a2630;
    }
    html,body{
      margin:0; height:100%;
      background:linear-gradient(180deg,#0f1320 0%, #121621 60%, #0f1320 100%);
      color:var(--hud);
      font-family:"Pretendard","Malgun Gothic","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    .panel{
      background:var(--glass);
      border:1px solid rgba(255,255,255,.07);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 30px var(--ink);
    }
    h1{ margin: 0 0 14px; font-size: 20px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    label{
      font-size: 12px;
      opacity: .9;
      display:block;
      margin-bottom: 6px;
    }
    input{
      width:100%;
      background:#0f1526;
      border:1px solid rgba(255,255,255,.15);
      color:#eef3ff;
      padding:10px 12px;
      border-radius:10px;
      outline:none;
      box-sizing:border-box;
    }
    button{
      background:var(--btn);
      color:#eaf1ff;
      border:1px solid var(--btnBorder);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ filter:brightness(1.05); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .danger{ background: var(--danger); border-color: rgba(255,255,255,.12); }
    .accent{ background: rgba(39,49,80,.85); border-color: rgba(255,255,255,.15); }
    .muted{ opacity:.75; font-size:12px; line-height:1.5; }
    .spacer{ height: 12px; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 12px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      vertical-align: middle;
    }
    th{ color:#bcd3ff; font-weight:600; }
    .tag{
      display:inline-block;
      font-size:12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
    }

    .toast{
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:#1e2538; border:1px solid rgba(255,255,255,.08);
      padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.35);
      display:none;
      max-width:min(720px,92vw);
      text-align:center;
      z-index:30;
    }

    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:50;
    }
    .dialog{
      width:min(460px,92vw);
      background:#192033; border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    .dialog h3{ margin:0 0 12px; font-size:18px; }
    .dialog p{ margin:8px 0 12px; font-size:14px; opacity:.92; }
  </style>
</head>

<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="overlay" id="pwOverlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>ğŸ”’ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì•„ì•¼ ê´€ë¦¬ì í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ìš”.</p>
      <div class="row">
        <input type="password" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" />
        <button id="pwSubmit">ì…ì¥</button>
      </div>
      <div class="muted" id="pwMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <h1>ğŸ† Leaderboard Admin</h1>
      <div class="muted">
        - Supabase leaderboard í…Œì´ë¸”ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.<br>
        - ì»¬ëŸ¼ ê°€ì •: <span class="tag">id</span> <span class="tag">name</span> <span class="tag">score</span> <span class="tag">max_combo</span> <span class="tag">created_at</span>
      </div>

      <div class="spacer"></div>

      <div class="grid">
        <div class="panel" style="box-shadow:none;">
          <h1 style="font-size:16px;margin:0 0 10px;">â• ìˆ˜ë™ ì ìˆ˜ ì¶”ê°€</h1>
          <div class="row">
            <div style="flex:1;min-width:220px;">
              <label>ë‹‰ë„¤ì„</label>
              <input id="name" placeholder="ì˜ˆ) halam" />
            </div>
            <div style="flex:1;min-width:160px;">
              <label>ì ìˆ˜</label>
              <input id="score" type="number" placeholder="ì˜ˆ) 120" />
            </div>
            <div style="flex:1;min-width:160px;">
              <label>ìµœëŒ€ ì½¤ë³´</label>
              <input id="maxCombo" type="number" placeholder="ì˜ˆ) 15" />
            </div>
          </div>

          <div class="spacer"></div>

          <div class="row">
            <button id="btnInsert" class="accent">ì €ì¥</button>
            <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
            <button id="btnLogout" class="danger">ë¡œê·¸ì•„ì›ƒ</button>
          </div>

          <div class="spacer"></div>
          <div class="muted">
            * ì´ í˜ì´ì§€ëŠ” í…ŒìŠ¤íŠ¸/ê´€ë¦¬ ìš©ë„ì…ë‹ˆë‹¤. ìš´ì˜ ê³µê°œëŠ” ê¶Œì¥í•˜ì§€ ì•Šì•„ìš”.
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <h1 style="font-size:16px;margin:0 0 10px;">ğŸ§¹ ê´€ë¦¬</h1>
          <div class="muted">
            - ì‚­ì œëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            - â€œì „ì²´ ì‚­ì œâ€ëŠ” ì§„ì§œ ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œë§Œ.
          </div>
          <div class="spacer"></div>
          <div class="row">
            <button id="btnDeleteAll" class="danger">ì „ì²´ ì‚­ì œ</button>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="panel" style="box-shadow:none;">
        <h1 style="font-size:16px;margin:0 0 10px;">ğŸ“‹ ìµœê·¼ Top 20</h1>
        <table>
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>ë‹‰ë„¤ì„</th>
              <th style="width:110px;">ì ìˆ˜</th>
              <th style="width:110px;">ìµœëŒ€ ì½¤ë³´</th>
              <th style="width:140px;">ë‚ ì§œ</th>
              <th style="width:110px;">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://oykepnxnbyltcvcqnfbe.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_85W1hHMVmhILGBbrX-l4wg_qmLCn987";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ACCESS_PASSWORD = "halam0202";
    const ACCESS_KEY = "wam_admin_access_ok_v1";

    const toastEl = document.getElementById("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toastEl.style.display = "none", 1800);
    }

    const pwOverlay = document.getElementById("pwOverlay");
    const pwInput = document.getElementById("pwInput");
    const pwSubmit = document.getElementById("pwSubmit");
    const pwMsg = document.getElementById("pwMsg");

    function showPw(msg=""){
      pwMsg.textContent = msg;
      pwOverlay.style.display = "flex";
      pwInput.value = "";
      pwInput.focus();
    }

    function hidePw(){
      pwOverlay.style.display = "none";
    }

    function unlock(){
      localStorage.setItem(ACCESS_KEY, "1");
      hidePw();
      loadRows();
    }

    function lock(){
      localStorage.removeItem(ACCESS_KEY);
      showPw("ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
    }

    if(localStorage.getItem(ACCESS_KEY) === "1"){
      hidePw();
    } else {
      showPw();
    }

    pwSubmit.addEventListener("click", ()=>{
      const v = pwInput.value.trim();
      if(v === ACCESS_PASSWORD){
        unlock();
      } else {
        showPw("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      }
    });

    pwInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") pwSubmit.click();
    });

    const rowsEl = document.getElementById("rows");

    function fmtDate(d){
      try{ return new Date(d).toLocaleDateString("ko-KR"); }catch{ return "-"; }
    }

    async function loadRows(){
      if(localStorage.getItem(ACCESS_KEY) !== "1") return;

      rowsEl.innerHTML = `<tr><td colspan="6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>`;

      const { data, error } = await supabase
        .from("leaderboard")
        .select("id,name,score,max_combo,created_at")
        .order("score", { ascending: false })
        .order("max_combo", { ascending: false })
        .order("created_at", { ascending: true })
        .limit(20);

      if(error){
        rowsEl.innerHTML = `<tr><td colspan="6">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</td></tr>`;
        return;
      }

      if(!data || data.length === 0){
        rowsEl.innerHTML = `<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      rowsEl.innerHTML = data.map((r, i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${String(r.name ?? "")}</td>
          <td>${Number(r.score ?? 0)}</td>
          <td>${Number(r.max_combo ?? 0)}</td>
          <td>${fmtDate(r.created_at)}</td>
          <td><button class="danger" data-del="${r.id}">ì‚­ì œ</button></td>
        </tr>
      `).join("");

      rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del");
          if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;

          const { error: delErr } = await supabase
            .from("leaderboard")
            .delete()
            .eq("id", id);

          if(delErr){
            toast("ì‚­ì œ ì‹¤íŒ¨: " + delErr.message);
            return;
          }

          toast("ì‚­ì œ ì™„ë£Œ");
          loadRows();
        });
      });
    }

    document.getElementById("btnRefresh").addEventListener("click", loadRows);

    document.getElementById("btnLogout").addEventListener("click", ()=>{
      localStorage.removeItem(ACCESS_KEY);
      showPw("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    document.getElementById("btnInsert").addEventListener("click", async ()=>{
      if(localStorage.getItem(ACCESS_KEY) !== "1"){
        showPw("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const score = Number(document.getElementById("score").value);
      const max_combo = Number(document.getElementById("maxCombo").value);

      if(!name || name.length < 2 || name.length > 12){
        toast("ë‹‰ë„¤ì„ì€ 2~12ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if(!Number.isFinite(score) || score < 0){
        toast("ì ìˆ˜ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•´ìš”.");
        return;
      }
      if(!Number.isFinite(max_combo) || max_combo < 0){
        toast("ìµœëŒ€ ì½¤ë³´ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•´ìš”.");
        return;
      }

      const { error } = await supabase
        .from("leaderboard")
        .insert([{ name, score, max_combo }]);

      if(error){
        toast("ì €ì¥ ì‹¤íŒ¨: " + error.message);
        return;
      }

      toast("ì €ì¥ ì™„ë£Œ!");
      document.getElementById("name").value = "";
      document.getElementById("score").value = "";
      document.getElementById("maxCombo").value = "";
      loadRows();
    });

    document.getElementById("btnDeleteAll").addEventListener("click", async ()=>{
      if(localStorage.getItem(ACCESS_KEY) !== "1"){
        showPw("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const phrase = prompt("ì „ì²´ ì‚­ì œí•˜ë ¤ë©´ 'DELETE ALL' ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
      if(phrase !== "DELETE ALL") return;

      const { error } = await supabase
        .from("leaderboard")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      if(error){
        toast("ì „ì²´ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
        return;
      }

      toast("ì „ì²´ ì‚­ì œ ì™„ë£Œ");
      loadRows();
    });

    if(localStorage.getItem(ACCESS_KEY) === "1"){
      loadRows();
    }
  </script>
</body>
</html>
