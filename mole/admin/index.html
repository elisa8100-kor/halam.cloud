<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard ê´€ë¦¬ì</title>
  <style>
    :root{
      --bg:#0f1320; --card:#151b2a; --line:rgba(255,255,255,.12);
      --text:#eaeaf0; --muted:rgba(234,234,240,.72);
      --btn:#273150; --btn2:#1f263b; --danger:#b83b3b; --ok:#2f7d4e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Pretendard", "Malgun Gothic", sans-serif;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#0b0f1a 0%, var(--bg) 70%); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:22px 14px 40px;}
    h1{font-size:20px; margin:0 0 12px;}
    .card{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .row > *{flex:1 1 auto;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.2);
      color:var(--text); outline:none;
    }
    input:focus{border-color:rgba(255,255,255,.26)}
    button{
      border:1px solid var(--line); background:var(--btn);
      color:var(--text); padding:11px 12px; border-radius:12px;
      cursor:pointer; font-weight:600;
    }
    button:hover{filter:brightness(1.06)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn2{background:var(--btn2)}
    .danger{background:rgba(184,59,59,.18); border-color:rgba(184,59,59,.55)}
    .ok{background:rgba(47,125,78,.18); border-color:rgba(47,125,78,.55)}
    .muted{color:var(--muted); font-size:12px;}
    .spacer{height:12px;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th,td{padding:10px 8px; border-bottom:1px solid var(--line); font-size:14px;}
    th{color:var(--muted); font-weight:700; text-align:left; font-size:12px;}
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right;}
    .pill{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted);}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .msg{margin-top:10px; font-size:13px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(0,0,0,.18);}
    .msg.err{border-color:rgba(184,59,59,.55); background:rgba(184,59,59,.12)}
    .msg.ok{border-color:rgba(47,125,78,.55); background:rgba(47,125,78,.12)}
    .small{font-size:12px;}
    .id{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>ğŸ Leaderboard ê´€ë¦¬ì</h1>
      <div class="row" style="flex:0 0 auto; gap:8px;">
        <span id="statusPill" class="pill">ìƒíƒœ: í™•ì¸ ì¤‘â€¦</span>
        <button id="refreshBtn" class="btn2" type="button">ìƒˆë¡œê³ ì¹¨</button>
        <button id="signOutBtn" class="btn2" type="button" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="card" id="loginCard">
      <div class="muted">ì‚­ì œëŠ” <b>ê´€ë¦¬ì ë¡œê·¸ì¸</b> í›„ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Supabase Auth + DELETE ì •ì±… í•„ìš”)</div>

      <form id="loginForm">
        <div class="row">
          <div>
            <label for="email">ê´€ë¦¬ì ì´ë©”ì¼</label>
            <input id="email" type="email" autocomplete="username" required />
          </div>
          <div>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" autocomplete="current-password" required />
          </div>
        </div>

        <div class="spacer"></div>
        <div class="row" style="justify-content:flex-end;">
          <button id="loginBtn" class="ok" type="submit" style="flex:0 0 auto;">ë¡œê·¸ì¸</button>
        </div>
      </form>

      <div id="loginMsg"></div>
    </div>

    <div class="spacer"></div>

    <div class="card" id="dataCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div>
          <label for="search">ê²€ìƒ‰ (ì´ë¦„)</label>
          <input id="search" placeholder="ì˜ˆ: halam" />
        </div>
        <div style="flex:0 0 auto;">
          <button id="clearAllBtn" class="danger" type="button" title="ì£¼ì˜: ì „ì²´ ì‚­ì œ">ì „ì²´ ì‚­ì œ(ìœ„í—˜)</button>
        </div>
      </div>

      <div id="dataMsg"></div>

      <table>
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>ì´ë¦„</th>
            <th class="right">ì ìˆ˜</th>
            <th class="right">ìµœëŒ€ì½¤ë³´</th>
            <th>ìƒì„±ì‹œê°„</th>
            <th class="right">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
        </tbody>
      </table>

      <div class="muted small" style="margin-top:10px;">
        ì •ë ¬: score â†“, max_combo â†“, created_at â†‘
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // âœ… ë„ˆ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ ê³ ì •
    const SUPABASE_URL = "https://oykepnxnbyltcvcqnfbe.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_85W1hHMVmhILGBbrX-l4wg_qmLCn987";
    const TABLE = "leaderboard";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const statusPill = document.getElementById("statusPill");
    const loginCard = document.getElementById("loginCard");
    const dataCard = document.getElementById("dataCard");
    const signOutBtn = document.getElementById("signOutBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const dataMsg = document.getElementById("dataMsg");
    const tbody = document.getElementById("tbody");
    const searchInput = document.getElementById("search");
    const clearAllBtn = document.getElementById("clearAllBtn");

    let cachedRows = [];

    function setPill(text, ok = false){
      statusPill.textContent = text;
      statusPill.style.borderColor = ok ? "rgba(47,125,78,.55)" : "rgba(255,255,255,.12)";
      statusPill.style.color = ok ? "rgba(234,234,240,.92)" : "rgba(234,234,240,.72)";
      statusPill.style.background = ok ? "rgba(47,125,78,.12)" : "rgba(255,255,255,.04)";
    }

    function showMsg(el, text, type=""){
      if(!text){ el.innerHTML = ""; return; }
      const cls = type === "err" ? "msg err" : type === "ok" ? "msg ok" : "msg";
      el.innerHTML = `<div class="${cls}">${escapeHtml(text)}</div>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso ?? "";
        return d.toLocaleString();
      }catch{ return iso ?? ""; }
    }

    function applyFilterAndRender(){
      const q = searchInput.value.trim().toLowerCase();
      const rows = q
        ? cachedRows.filter(r => (r.name ?? "").toLowerCase().includes(q))
        : cachedRows;

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map((r, idx) => {
        const rank = idx + 1;
        return `
          <tr>
            <td>${rank}</td>
            <td>
              <div>${escapeHtml(r.name ?? "")}</div>
              <div class="id">${escapeHtml(String(r.id ?? ""))}</div>
            </td>
            <td class="right">${escapeHtml(String(r.score ?? ""))}</td>
            <td class="right">${escapeHtml(String(r.max_combo ?? ""))}</td>
            <td>${escapeHtml(fmtDate(r.created_at))}</td>
            <td class="right">
              <button class="danger" data-del="${escapeHtml(String(r.id))}">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join("");

      // bind delete buttons
      tbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          await deleteRowById(id);
        });
      });
    }

    async function loadLeaderboard(){
      showMsg(dataMsg, "");
      tbody.innerHTML = `<tr><td colspan="6" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>`;

      const { data, error } = await supabase
        .from(TABLE)
        .select("id, created_at, name, score, max_combo")
        .order("score", { ascending: false })
        .order("max_combo", { ascending: false })
        .order("created_at", { ascending: true })
        .limit(500);

      if(error){
        cachedRows = [];
        tbody.innerHTML = `<tr><td colspan="6" class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>`;
        showMsg(dataMsg, "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message, "err");
        return;
      }

      cachedRows = data ?? [];
      applyFilterAndRender();
    }

    async function deleteRowById(id){
      showMsg(dataMsg, "");
      const ok = confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”?\n\nid: ${id}`);
      if(!ok) return;

      const { error } = await supabase
        .from(TABLE)
        .delete()
        .eq("id", id);

      if(error){
        showMsg(dataMsg, "ì‚­ì œ ì‹¤íŒ¨: " + error.message + "\n(DELETE ì •ì±…ì´ authenticatedì— ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸)", "err");
        return;
      }

      showMsg(dataMsg, "ì‚­ì œ ì™„ë£Œ!", "ok");
      // local remove + rerender (ë¹ ë¥´ê²Œ)
      cachedRows = cachedRows.filter(r => String(r.id) !== String(id));
      applyFilterAndRender();
    }

    async function clearAllDanger(){
      const phrase = "ì „ì²´ì‚­ì œ";
      const input = prompt(`âš ï¸ ì •ë§ ì „ì²´ ì‚­ì œí•˜ë ¤ë©´ "${phrase}" ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)`);
      if(input !== phrase) return;

      // ì „ì²´ ì‚­ì œ: where true ê°™ì€ í˜•íƒœê°€ í•„ìš”í•´ eq ì¡°ê±´ ì—†ì´ deleteëŠ” ë§‰í ìˆ˜ ìˆì–´ìš”.
      // created_at ê¸°ì¤€ìœ¼ë¡œ ë„“ê²Œ ì§€ìš°ëŠ” ì•ˆì „í•œ ë°©ì‹(ì¡´ì¬í•˜ëŠ” ê°’ ì¡°ê±´)
      const ok = confirm("ì§„ì§œë¡œ ALL DELETE ì‹¤í–‰í• ê¹Œìš”?");
      if(!ok) return;

      const { error } = await supabase
        .from(TABLE)
        .delete()
        .not("id", "is", null);

      if(error){
        showMsg(dataMsg, "ì „ì²´ ì‚­ì œ ì‹¤íŒ¨: " + error.message, "err");
        return;
      }
      showMsg(dataMsg, "ì „ì²´ ì‚­ì œ ì™„ë£Œ!", "ok");
      cachedRows = [];
      applyFilterAndRender();
    }

    async function syncAuthUI(){
      const { data: { session } } = await supabase.auth.getSession();

      if(session?.user){
        setPill("ìƒíƒœ: ê´€ë¦¬ì ë¡œê·¸ì¸ë¨", true);
        loginCard.style.display = "none";
        dataCard.style.display = "block";
        signOutBtn.style.display = "inline-block";
        await loadLeaderboard();
      }else{
        setPill("ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨", false);
        loginCard.style.display = "block";
        dataCard.style.display = "none";
        signOutBtn.style.display = "none";
      }
    }

    // events
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      showMsg(loginMsg, "");

      loginBtn.disabled = true;
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });

      loginBtn.disabled = false;

      if(error){
        showMsg(loginMsg, "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message, "err");
        return;
      }

      showMsg(loginMsg, "ë¡œê·¸ì¸ ì„±ê³µ!", "ok");
      await syncAuthUI();
    });

    signOutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await syncAuthUI();
    });

    refreshBtn.addEventListener("click", async () => {
      if(dataCard.style.display !== "none") await loadLeaderboard();
      else await syncAuthUI();
    });

    searchInput.addEventListener("input", () => applyFilterAndRender());
    clearAllBtn.addEventListener("click", clearAllDanger);

    // session changes
    supabase.auth.onAuthStateChange(async () => {
      await syncAuthUI();
    });

    // init
    await syncAuthUI();
  </script>
</body>
</html>
